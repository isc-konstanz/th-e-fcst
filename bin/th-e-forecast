#!/usr/bin/python
# -*- coding: utf-8 -*-
"""
    th-e-forecast
    ~~~~~
    
"""
import logging.config

import sys
import os
from boto import config
from pygments.lexers import configs
from theforecast.database import CsvDatabase
sys.path.insert(0, os.path.dirname(os.path.abspath(sys.argv[0])))

from argparse import ArgumentParser
from configparser import ConfigParser
import json
import shutil
import inspect
import matplotlib.pyplot as plt
from keras.models import load_model
import numpy as np
import time
from scipy import signal


def plot_results(system, input, prediction, k, pred_start):
    plt.figure(1)
    plt.clf()
    bi = (system.databases['CSV'].data[0][pred_start - 7 * 1440 + k:pred_start + 1440 + k] + 1) / 2
    b, a = signal.butter(8, 0.01)  # lowpass filter of order = 8 and critical frequency = 0.01 (-3dB)
    bi = signal.filtfilt(b, a, bi, padlen=150)
    
    plt.plot(np.linspace(50 + k / 1440, 58 + k / 1440, 8 * 1440), bi, 'k--')
    
    plt.plot(np.linspace(50 + k / 1440, 55 + k / 1440, 120), input[0, 0, 0:120], 'r--')
    plt.plot(np.linspace(55 + k / 1440, 56.9166 + k / 1440, 184), input[0, 0, 120:304], 'r')
    plt.plot(np.linspace(56.9166 + k / 1440 + 7.5 / 1440, 57 + k / 1440, 24), input[0, 0, 304:], 'g')
    
#     plt.plot(np.linspace(50 + k / 1440, 55 + k / 1440, 120), input[0, 1, 0:120] * 100 + 0.5, 'g')
#     plt.plot(np.linspace(55 + k / 1440, 56.9166 + k / 1440, 184), input[0, 1, 120:304] * 100 + 0.5, 'g')
#     plt.plot(np.linspace(56.9166 + k / 1440 + 7.5 / 1440, 57 + k / 1440, 24), input[0, 1, 304:] * 100 + 0.5, 'g')
    
    plt.plot(np.linspace(57 + k / 1440 + 5 / 1440, 58 + k / 1440 + 5 / 1440, int(system.neuralnetwork.lookAhead / system.neuralnetwork.fMin)), prediction[0, :].transpose(), 'b')
    # plt.plot(np.linspace(57 + k / 1440 + 5 / 1440, 58 + k / 1440 + 5 / 1440, int(system.neuralnetwork.lookAhead / system.neuralnetwork.fMin)), prediction[0, 1, :].transpose(), 'b--', linewidth=0.3)
    # plt.plot(np.linspace(57 + k / 1440 + 5 / 1440, 58 + k / 1440 + 5 / 1440, int(system.neuralnetwork.lookAhead / system.neuralnetwork.fMin)), prediction[0, 2, :].transpose(), 'b') * 100 + 0.5
    # plt.plot(np.linspace(57 + k / 1440 + 5 / 1440, 58 + k / 1440 + 5 / 1440, int(system.neuralnetwork.lookAhead / system.neuralnetwork.fMin)), prediction[0, 3, :].transpose(), 'b')
    plt.grid()
    plt.xlim([55 + k / 1440, 58.2 + k / 1440])
    plt.pause(0.1)
    plt.savefig('plots\\name' + str(k))
    
    
def main(rundir, args=None):
    from theforecast import Forecast, ForecastException
    from theforecast.neuralnetwork import NeuralNetwork
    
    # Parameter:
    nTrainingDays = 30
    nInputDays = 7
    
    if args.configs != None:
        configs = args.configs
        logger.debug('System configurations will be read in from "%s"', configs)
    else:
        configs = os.path.join(rundir, 'conf')
    
    # load prediction class  
    system = Forecast(configs)
    data = system.databases['CSV'].data

    iStart = (nTrainingDays - nInputDays) * 1440
    dataTraining = [data[0][iStart:],  # BI
                    data[1][iStart:]]  # timestamp
    
    X, Y = system.neuralnetwork.getInputVector(dataTraining,
                                               system.neuralnetwork.lookBack,
                                               system.neuralnetwork.lookAhead,
                                               system.neuralnetwork.fMin,
                                               training=True)
    
    try:
        model = load_model('myModel')
        if model.get_config() == system.neuralnetwork.model.get_config():
            system.neuralnetwork.model = model
        elif model.get_config() != system.neuralnetwork.model.get_config():
            system.neuralnetwork.model.fit(X, Y[:, 0, :], epochs=4, batch_size=64, verbose=2)
            system.neuralnetwork.model.save('myModel')
        # system.neuralnetwork.model.save('myModel2D')
    except (OSError) as e:
        system.neuralnetwork.model.fit(X, Y, epochs=8, batch_size=64, verbose=2)
        system.neuralnetwork.model.save('myModel2D')
        logger.error('No model found. Import error: %s', str(e))
                    
#     load_model_conf = False
#     if load_model_conf:
#          system.neuralnetwork.model = load_model('myModel4D')
#          # system.neuralnetwork.model.fit(X, Y, epochs=1, batch_size=64, verbose=2)
#     if not load_model_conf:
#         system.neuralnetwork.model = load_model('myModel4D')
#         system.neuralnetwork.model.fit(X, Y, epochs=1, batch_size=64, verbose=2)
#         system.neuralnetwork.model.save('myModel4D')
    # TODO: safe model under the config path
    
    k = 0
    pred_start = 50 * 1440
    f_prediction = 10
    
    plt.figure(1)
    mng = plt.get_current_fig_manager()
    plt.pause(.1)
    mng.window.showMaximized()
    
    while True:           
        try:
            if k % f_prediction == 0:
                input, prediction = system.execute(pred_start, k)
                
        except (ForecastException) as e:
            logger.error('Fatal forecast error: %s', str(e))
            sys.exit(1)  # abnormal termination
        k = k + system.neuralnetwork.fMin
        # system.databases['CSV'].persist(prediction)
        
        plot_results(system, input, prediction, k, pred_start)
        time.sleep(.1)
            
    sys.exit(0)  # successful termination


if __name__ == '__main__':

    rundir = os.path.dirname(os.path.abspath(inspect.getsourcefile(main)))
    if os.path.basename(rundir) == 'bin':
        rundir = os.path.dirname(rundir)
    
    # Load the logging configuration
    logging.config.fileConfig(os.path.join(rundir, 'conf', 'logging.cfg'))
    logger = logging.getLogger('th-e-forecast')
    
    parser = ArgumentParser(description=__doc__)
    parser.add_argument('-c', '--configs',
                        dest='configs',
                        help='Directory of system configuration files',
                        metavar='DIR')
    
    main(rundir, args=parser.parse_args())
    
